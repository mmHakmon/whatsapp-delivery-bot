generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            Int       @id @default(autoincrement())
  phone         String    @unique
  name          String
  role          String    @default("admin")
  password      String
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  deliveries    Delivery[]
  chatMessages  Chat[]
  blacklistsCreated CourierBlacklist[]
}

model Courier {
  id                Int       @id @default(autoincrement())
  phone             String    @unique
  name              String
  vehicleType       String
  isActive          Boolean   @default(true)
  isAvailable       Boolean   @default(true)
  currentLat        Float?
  currentLng        Float?
  lastLocationUpdate DateTime?
  totalDeliveries   Int       @default(0)
  completedDeliveries Int     @default(0)
  cancelledDeliveries Int     @default(0)
  rating            Float     @default(5.0)
  totalEarnings     Float     @default(0)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  deliveries        Delivery[]
  performance       CourierPerformance[]
  blacklistEntries  CourierBlacklist[]
  alerts            Alert[]
}

model Customer {
  id            Int       @id @default(autoincrement())
  phone         String    @unique
  name          String
  email         String?
  address       String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  deliveriesFrom Delivery[] @relation("CustomerFrom")
  deliveriesTo   Delivery[] @relation("CustomerTo")
}

model Delivery {
  id                Int       @id @default(autoincrement())
  orderNumber       String    @unique @default(uuid())
  vehicleType       String
  packageType       String?
  
  pickupAddress     String
  pickupLat         Float?
  pickupLng         Float?
  pickupCity        String?
  pickupZone        String?
  
  deliveryAddress   String
  deliveryLat       Float?
  deliveryLng       Float?
  deliveryCity      String?
  deliveryZone      String?
  
  distance          Float?
  basePrice         Float
  pricePerKm        Float
  totalPrice        Float
  vatAmount         Float
  finalPrice        Float
  courierEarnings   Float?
  companyEarnings   Float?
  
  customerFromId    Int?
  customerFrom      Customer? @relation("CustomerFrom", fields: [customerFromId], references: [id])
  customerFromPhone String?
  customerFromName  String?
  
  customerToId      Int?
  customerTo        Customer? @relation("CustomerTo", fields: [customerToId], references: [id])
  customerToPhone   String?
  customerToName    String?
  
  courierId         Int?
  courier           Courier?  @relation(fields: [courierId], references: [id])
  
  status            String    @default("pending")
  
  publishedAt       DateTime?
  claimedAt         DateTime?
  pickedUpAt        DateTime?
  deliveredAt       DateTime?
  completedAt       DateTime?
  
  estimatedPickupTime   Int?
  estimatedDeliveryTime Int?
  
  notes             String?
  priority          Int       @default(0)
  isNightDelivery   Boolean   @default(false)
  nightSurcharge    Float     @default(0)
  
  pickupPhotoUrl    String?
  deliveryPhotoUrl  String?
  
  createdById       Int?
  createdBy         User?     @relation(fields: [createdById], references: [id])
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  chats             Chat[]
  alerts            Alert[]
  learningData      DeliveryTimeLearning[]
}

model PricingZone {
  id                    Int       @id @default(autoincrement())
  name                  String
  polygon               Json
  
  motorcycleBase        Float
  motorcyclePerKm       Float
  carBase               Float
  carPerKm              Float
  vanBase               Float
  vanPerKm              Float
  truckBase             Float
  truckPerKm            Float
  
  nightSurcharge        Float     @default(1.5)
  isActive              Boolean   @default(true)
  
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
}

model CourierPerformance {
  id                    Int       @id @default(autoincrement())
  courierId             Int
  courier               Courier   @relation(fields: [courierId], references: [id])
  
  date                  DateTime  @db.Date
  totalDeliveries       Int       @default(0)
  completedDeliveries   Int       @default(0)
  cancelledDeliveries   Int       @default(0)
  
  avgPickupTime         Int?
  avgDeliveryTime       Int?
  totalEarnings         Float     @default(0)
  ratingAverage         Float?
  
  createdAt             DateTime  @default(now())
  
  @@unique([courierId, date])
}

model CourierBlacklist {
  id                Int       @id @default(autoincrement())
  courierId         Int
  courier           Courier   @relation(fields: [courierId], references: [id])
  
  reason            String
  startDate         DateTime  @default(now())
  endDate           DateTime?
  
  createdById       Int
  createdBy         User      @relation(fields: [createdById], references: [id])
  
  isActive          Boolean   @default(true)
  createdAt         DateTime  @default(now())
}

model Chat {
  id                Int       @id @default(autoincrement())
  deliveryId        Int
  delivery          Delivery  @relation(fields: [deliveryId], references: [id])
  
  senderId          Int
  sender            User      @relation(fields: [senderId], references: [id])
  senderType        String
  
  message           String
  isRead            Boolean   @default(false)
  
  createdAt         DateTime  @default(now())
}

model DeliveryTimeLearning {
  id                Int       @id @default(autoincrement())
  deliveryId        Int
  delivery          Delivery  @relation(fields: [deliveryId], references: [id])
  
  fromZone          String
  toZone            String
  distanceKm        Float
  actualTimeMinutes Int
  
  trafficLevel      String
  dayOfWeek         Int
  hourOfDay         Int
  weather           String?
  
  createdAt         DateTime  @default(now())
}

model Alert {
  id                Int       @id @default(autoincrement())
  alertType         String
  
  deliveryId        Int?
  delivery          Delivery? @relation(fields: [deliveryId], references: [id])
  
  courierId         Int?
  courier           Courier?  @relation(fields: [courierId], references: [id])
  
  message           String
  isRead            Boolean   @default(false)
  isResolved        Boolean   @default(false)
  
  createdAt         DateTime  @default(now())
  resolvedAt        DateTime?
}
