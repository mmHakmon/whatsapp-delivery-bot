<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#10b981">
  <title>×”×¨×•×•×—×™× ×©×œ×™ - M.M.H Delivery</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', sans-serif;
      background-color: #0f172a;
      color: #ffffff;
      line-height: 1.5;
      padding-bottom: 100px;
    }

    .header {
      background: #1e293b;
      border-bottom: 1px solid #475569;
      position: sticky;
      top: 0;
      z-index: 40;
      backdrop-filter: blur(20px);
    }

    .header-content {
      padding: 1rem;
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .back-btn {
      width: 2.5rem;
      height: 2.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 0.5rem;
      background: #334155;
      border: none;
      color: white;
      cursor: pointer;
    }

    .header-title {
      flex: 1;
    }

    .header-title h1 {
      font-size: 1.25rem;
      font-weight: 700;
    }

    .header-title p {
      font-size: 0.875rem;
      color: #9ca3af;
    }

    .container {
      padding: 1rem;
      max-width: 800px;
      margin: 0 auto;
    }

    .balance-card {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      border-radius: 1.5rem;
      padding: 2rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3);
    }

    .balance-amount {
      font-size: 3rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
    }

    .balance-label {
      font-size: 1rem;
      opacity: 0.9;
      margin-bottom: 1.5rem;
    }

    .balance-actions {
      display: flex;
      gap: 0.75rem;
    }

    .btn {
      flex: 1;
      padding: 0.75rem;
      border-radius: 0.75rem;
      font-weight: 600;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      transition: all 0.2s;
    }

    .btn-white {
      background: white;
      color: #059669;
    }

    .btn-outline {
      background: transparent;
      color: white;
      border: 2px solid white;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .stat-card {
      background: #1e293b;
      border-radius: 1rem;
      padding: 1.5rem;
      border: 1px solid #475569;
    }

    .stat-value {
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 0.25rem;
    }

    .stat-label {
      font-size: 0.875rem;
      color: #9ca3af;
    }

    .stat-change {
      font-size: 0.75rem;
      margin-top: 0.5rem;
      padding: 0.25rem 0.5rem;
      border-radius: 0.25rem;
      display: inline-block;
    }

    .stat-change.positive {
      background: rgba(16, 185, 129, 0.1);
      color: #34d399;
    }

    .stat-change.negative {
      background: rgba(239, 68, 68, 0.1);
      color: #f87171;
    }

    .section {
      background: #1e293b;
      border-radius: 1rem;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      border: 1px solid #475569;
    }

    .section-title {
      font-size: 1.125rem;
      font-weight: 700;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .filter-tabs {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1.5rem;
      overflow-x: auto;
      padding-bottom: 0.5rem;
    }

    .filter-tab {
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      background: transparent;
      border: 1px solid #475569;
      color: #9ca3af;
      cursor: pointer;
      white-space: nowrap;
      transition: all 0.2s;
    }

    .filter-tab.active {
      background: #10b981;
      border-color: #10b981;
      color: white;
    }

    .chart-container {
      position: relative;
      height: 250px;
      margin-bottom: 1rem;
    }

    .transaction-list {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .transaction-item {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 1rem;
      background: #0f172a;
      border-radius: 0.75rem;
      border: 1px solid #334155;
    }

    .transaction-icon {
      width: 3rem;
      height: 3rem;
      border-radius: 0.75rem;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      flex-shrink: 0;
    }

    .transaction-icon.income {
      background: rgba(16, 185, 129, 0.1);
    }

    .transaction-icon.expense {
      background: rgba(239, 68, 68, 0.1);
    }

    .transaction-details {
      flex: 1;
    }

    .transaction-title {
      font-weight: 600;
      margin-bottom: 0.25rem;
    }

    .transaction-date {
      font-size: 0.875rem;
      color: #9ca3af;
    }

    .transaction-amount {
      font-weight: 700;
      font-size: 1.125rem;
    }

    .transaction-amount.income {
      color: #34d399;
    }

    .transaction-amount.expense {
      color: #f87171;
    }

    .empty-state {
      text-align: center;
      padding: 3rem 1rem;
      color: #9ca3af;
    }

    .empty-state-icon {
      font-size: 4rem;
      margin-bottom: 1rem;
    }

    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(4px);
      z-index: 50;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 1rem;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal-content {
      background: #1e293b;
      border-radius: 1.5rem;
      padding: 2rem;
      max-width: 400px;
      width: 100%;
      border: 1px solid #475569;
    }

    .modal-title {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 1.5rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .form-group {
      margin-bottom: 1rem;
    }

    .form-label {
      display: block;
      font-size: 0.875rem;
      font-weight: 500;
      margin-bottom: 0.5rem;
      color: #e5e7eb;
    }

    .form-input,
    .form-select {
      width: 100%;
      background: #0f172a;
      border: 1px solid #475569;
      padding: 0.75rem;
      border-radius: 0.5rem;
      color: white;
      font-size: 1rem;
    }

    .form-input:focus,
    .form-select:focus {
      outline: none;
      border-color: #10b981;
    }

    .btn-group {
      display: flex;
      gap: 0.75rem;
      margin-top: 1.5rem;
    }

    .btn-secondary {
      background: #334155;
      color: white;
    }

    .btn-primary {
      background: linear-gradient(to right, #10b981, #059669);
      color: white;
    }

    @media (max-width: 640px) {
      .stats-grid {
        grid-template-columns: 1fr;
      }
      
      .balance-actions {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>

  <!-- Header -->
  <header class="header">
    <div class="header-content">
      <button class="back-btn" onclick="goBack()">
        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
        </svg>
      </button>
      <div class="header-title">
        <h1>×”×¨×•×•×—×™× ×©×œ×™</h1>
        <p id="courierName">×˜×•×¢×Ÿ...</p>
      </div>
    </div>
  </header>

  <!-- Main Container -->
  <div class="container">
    
    <!-- Balance Card -->
    <div class="balance-card">
      <div class="balance-amount" id="totalBalance">â‚ª0</div>
      <div class="balance-label">×™×ª×¨×” ×–××™× ×” ×œ××©×™×›×”</div>
      <div class="balance-actions">
        <button class="btn btn-white" onclick="requestPayout()">
          ğŸ’° ×‘×§×©×ª ×ª×©×œ×•×
        </button>
        <button class="btn btn-outline" onclick="viewPayoutHistory()">
          ğŸ“‹ ×”×™×¡×˜×•×¨×™×”
        </button>
      </div>
    </div>

    <!-- Stats Grid -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-value" style="color: #10b981;" id="thisMonthEarnings">â‚ª0</div>
        <div class="stat-label">×”×¨×•×•×—×ª ×”×—×•×“×©</div>
        <div class="stat-change positive" id="monthChange">+0%</div>
      </div>

      <div class="stat-card">
        <div class="stat-value" style="color: #60a5fa;" id="thisMonthDeliveries">0</div>
        <div class="stat-label">××©×œ×•×—×™× ×”×—×•×“×©</div>
        <div class="stat-change positive" id="deliveriesChange">+0</div>
      </div>

      <div class="stat-card">
        <div class="stat-value" style="color: #fbbf24;" id="avgPerDelivery">â‚ª0</div>
        <div class="stat-label">×××•×¦×¢ ×œ××©×œ×•×—</div>
      </div>

      <div class="stat-card">
        <div class="stat-value" style="color: #c084fc;" id="totalEarned">â‚ª0</div>
        <div class="stat-label">×¡×”"×› ×”×¨×•×•×—×ª</div>
      </div>
    </div>

    <!-- Earnings Chart -->
    <div class="section">
      <div class="section-title">
        <span>ğŸ“Š ×’×¨×£ ×”×›× ×¡×•×ª</span>
      </div>
      
      <div class="filter-tabs">
        <button class="filter-tab active" data-period="week" onclick="changePeriod('week', this)">×©×‘×•×¢</button>
        <button class="filter-tab" data-period="month" onclick="changePeriod('month', this)">×—×•×“×©</button>
        <button class="filter-tab" data-period="year" onclick="changePeriod('year', this)">×©× ×”</button>
      </div>

      <div class="chart-container">
        <canvas id="earningsChart"></canvas>
      </div>
    </div>

    <!-- Recent Transactions -->
    <div class="section">
      <div class="section-title">
        <span>ğŸ’¸ ×¤×¢×•×œ×•×ª ××—×¨×•× ×•×ª</span>
        <button class="filter-tab" onclick="loadTransactions()">ğŸ”„</button>
      </div>

      <div id="transactionList" class="transaction-list">
        <div class="empty-state">
          <div class="empty-state-icon">ğŸ“­</div>
          <div>××™×Ÿ ×¤×¢×•×œ×•×ª ×¢×“×™×™×Ÿ</div>
        </div>
      </div>
    </div>

  </div>

  <!-- Payout Request Modal -->
  <div id="payoutModal" class="modal-overlay" onclick="if(event.target===this) closePayoutModal()">
    <div class="modal-content">
      <div class="modal-title">
        ğŸ’° ×‘×§×©×ª ×ª×©×œ×•×
      </div>

      <form id="payoutForm">
        <div class="form-group">
          <label class="form-label">×¡×›×•× ×œ××©×™×›×”</label>
          <input 
            type="number" 
            id="payoutAmount" 
            class="form-input" 
            placeholder="0"
            min="50"
            required
          >
          <small style="color: #9ca3af; font-size: 0.75rem;">××™× ×™××•× â‚ª50</small>
        </div>

        <div class="form-group">
          <label class="form-label">×©×™×˜×ª ×ª×©×œ×•×</label>
          <select id="payoutMethod" class="form-select" required>
            <option value="">×‘×—×¨ ×©×™×˜×ª ×ª×©×œ×•×</option>
            <option value="bit">×‘×™×˜</option>
            <option value="paybox">×¤×™×™×‘×•×§×¡</option>
            <option value="bank">×”×¢×‘×¨×” ×‘× ×§××™×ª</option>
          </select>
        </div>

        <div class="form-group" id="accountDetails">
          <label class="form-label">×¤×¨×˜×™ ×—×©×‘×•×Ÿ</label>
          <input 
            type="text" 
            id="accountInfo" 
            class="form-input" 
            placeholder="××¡×¤×¨ ×˜×œ×¤×•×Ÿ / ××¡×¤×¨ ×—×©×‘×•×Ÿ"
          >
        </div>

        <div class="btn-group">
          <button type="button" class="btn btn-secondary" onclick="closePayoutModal()">×‘×™×˜×•×œ</button>
          <button type="submit" class="btn btn-primary">×©×œ×— ×‘×§×©×”</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const API_URL = window.location.origin;
    let courier = null;
    let courierPhone = null;
    let currentPeriod = 'week';
    let earningsChart = null;

    async function init() {
      const urlParams = new URLSearchParams(window.location.search);
      courierPhone = urlParams.get('phone') || localStorage.getItem('courier_phone');
      
      if (!courierPhone) {
        window.location.href = '/courier/login';
        return;
      }

      await loadCourierData();
      await loadEarningsData();
      initChart();
      await loadTransactions();
    }

    async function loadCourierData() {
      try {
        const response = await fetch(`${API_URL}/api/couriers/phone/${courierPhone}`);
        const data = await response.json();
        
        if (data.success) {
          courier = data.courier;
          document.getElementById('courierName').textContent = courier.first_name + ' ' + courier.last_name;
          document.getElementById('totalBalance').textContent = `â‚ª${courier.balance || 0}`;
        }
      } catch (error) {
        console.error('Error loading courier:', error);
      }
    }

    async function loadEarningsData() {
      try {
        const response = await fetch(`${API_URL}/api/couriers/${courier.id}/earnings`);
        const data = await response.json();
        
        if (data.success) {
          const earnings = data.earnings;
          
          document.getElementById('thisMonthEarnings').textContent = `â‚ª${earnings.thisMonth || 0}`;
          document.getElementById('thisMonthDeliveries').textContent = earnings.deliveriesThisMonth || 0;
          document.getElementById('avgPerDelivery').textContent = `â‚ª${earnings.avgPerDelivery || 0}`;
          document.getElementById('totalEarned').textContent = `â‚ª${earnings.totalEarned || 0}`;
          
          // Changes
          const monthChange = earnings.monthChange || 0;
          const deliveriesChange = earnings.deliveriesChange || 0;
          
          document.getElementById('monthChange').textContent = `${monthChange > 0 ? '+' : ''}${monthChange}%`;
          document.getElementById('monthChange').className = `stat-change ${monthChange >= 0 ? 'positive' : 'negative'}`;
          
          document.getElementById('deliveriesChange').textContent = `${deliveriesChange > 0 ? '+' : ''}${deliveriesChange}`;
          document.getElementById('deliveriesChange').className = `stat-change ${deliveriesChange >= 0 ? 'positive' : 'negative'}`;
        }
      } catch (error) {
        console.error('Error loading earnings:', error);
      }
    }

    function initChart() {
      const ctx = document.getElementById('earningsChart').getContext('2d');
      earningsChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: [],
          datasets: [{
            label: '×”×›× ×¡×•×ª',
            data: [],
            borderColor: '#10b981',
            backgroundColor: 'rgba(16, 185, 129, 0.1)',
            borderWidth: 3,
            fill: true,
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                color: '#9ca3af',
                callback: function(value) {
                  return 'â‚ª' + value;
                }
              },
              grid: {
                color: '#334155'
              }
            },
            x: {
              ticks: {
                color: '#9ca3af'
              },
              grid: {
                color: '#334155'
              }
            }
          }
        }
      });

      updateChart(currentPeriod);
    }

    async function updateChart(period) {
      try {
        const response = await fetch(`${API_URL}/api/couriers/${courier.id}/earnings/chart?period=${period}`);
        const data = await response.json();
        
        if (data.success) {
          earningsChart.data.labels = data.labels;
          earningsChart.data.datasets[0].data = data.values;
          earningsChart.update();
        }
      } catch (error) {
        console.error('Error updating chart:', error);
      }
    }

    function changePeriod(period, button) {
      currentPeriod = period;
      document.querySelectorAll('.filter-tab').forEach(tab => tab.classList.remove('active'));
      button.classList.add('active');
      updateChart(period);
    }

    async function loadTransactions() {
      try {
        const response = await fetch(`${API_URL}/api/couriers/${courier.id}/transactions`);
        const data = await response.json();
        
        const container = document.getElementById('transactionList');
        
        if (!data.success || data.transactions.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">ğŸ“­</div>
              <div>××™×Ÿ ×¤×¢×•×œ×•×ª ×¢×“×™×™×Ÿ</div>
            </div>
          `;
          return;
        }

        container.innerHTML = data.transactions.map(tx => `
          <div class="transaction-item">
            <div class="transaction-icon ${tx.type}">
              ${tx.type === 'income' ? 'ğŸ’°' : 'ğŸ’¸'}
            </div>
            <div class="transaction-details">
              <div class="transaction-title">${tx.description}</div>
              <div class="transaction-date">${formatDate(tx.created_at)}</div>
            </div>
            <div class="transaction-amount ${tx.type}">
              ${tx.type === 'income' ? '+' : '-'}â‚ª${Math.abs(tx.amount)}
            </div>
          </div>
        `).join('');
        
      } catch (error) {
        console.error('Error loading transactions:', error);
      }
    }

    function requestPayout() {
      document.getElementById('payoutModal').classList.add('active');
      document.getElementById('payoutAmount').value = '';
      document.getElementById('payoutMethod').value = '';
      document.getElementById('accountInfo').value = '';
    }

    function closePayoutModal() {
      document.getElementById('payoutModal').classList.remove('active');
    }

    function viewPayoutHistory() {
      window.location.href = `/courier/payout-history?phone=${courierPhone}`;
    }

    document.getElementById('payoutForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const amount = parseFloat(document.getElementById('payoutAmount').value);
      const method = document.getElementById('payoutMethod').value;
      const accountInfo = document.getElementById('accountInfo').value;
      
      if (amount < 50) {
        alert('×”×¡×›×•× ×”××™× ×™××œ×™ ×œ××©×™×›×” ×”×•× â‚ª50');
        return;
      }
      
      if (amount > courier.balance) {
        alert('×”×¡×›×•× ×’×‘×•×” ××”×™×ª×¨×” ×”×–××™× ×”');
        return;
      }

      try {
        const response = await fetch(`${API_URL}/api/couriers/${courier.id}/payout-request`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            amount,
            method,
            accountInfo
          })
        });

        const data = await response.json();

        if (data.success) {
          alert('âœ… ×‘×§×©×ª ×”×ª×©×œ×•× × ×©×œ×—×” ×‘×”×¦×œ×—×”!\n\n×”×‘×§×©×” ×ª×˜×•×¤×œ ×‘×§×¨×•×‘ ×•×ª×§×‘×œ ×¢×“×›×•×Ÿ.');
          closePayoutModal();
          loadCourierData();
          loadTransactions();
        } else {
          alert('×©×’×™××”: ' + (data.message || '× ×¡×” ×©×•×‘ ×××•×—×¨ ×™×•×ª×¨'));
        }
      } catch (error) {
        console.error('Payout request error:', error);
        alert('×©×’×™××” ×‘×©×œ×™×—×ª ×”×‘×§×©×”');
      }
    });

    function goBack() {
      window.location.href = `/courier-dashboard.html?phone=${courierPhone}`;
    }

    function formatDate(dateString) {
      const date = new Date(dateString);
      const now = new Date();
      const diffMs = now - date;
      const diffHours = Math.floor(diffMs / 3600000);
      const diffDays = Math.floor(diffMs / 86400000);
      
      if (diffHours < 24) return '×”×™×•×';
      if (diffDays === 1) return '××ª××•×œ';
      if (diffDays < 7) return `×œ×¤× ×™ ${diffDays} ×™××™×`;
      return date.toLocaleDateString('he-IL');
    }

    init();
  </script>
</body>
</html>
