<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×‘×“×™×§×ª Push Notifications</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-900 text-white p-8">
    <div class="max-w-2xl mx-auto">
        <h1 class="text-3xl font-bold mb-8">ğŸ”” ×‘×“×™×§×ª Push Notifications</h1>
        
        <div class="space-y-4 mb-8">
            <div class="bg-slate-800 p-4 rounded-lg">
                <h3 class="font-bold mb-2">×¡×˜×˜×•×¡ ××¢×¨×›×ª:</h3>
                <div id="status" class="space-y-2 text-sm"></div>
            </div>
        </div>

        <div class="space-y-4">
            <button onclick="checkStatus()" 
                    class="w-full bg-blue-500 hover:bg-blue-600 font-bold py-4 rounded-lg">
                ğŸ” ×‘×“×•×§ ×¡×˜×˜×•×¡
            </button>

            <button onclick="testPush()" 
                    class="w-full bg-emerald-500 hover:bg-emerald-600 font-bold py-4 rounded-lg">
                ğŸ”” ×‘×§×© ×”×¨×©××” ×œPUSH
            </button>

            <button onclick="showPrompt()" 
                    class="w-full bg-purple-500 hover:bg-purple-600 font-bold py-4 rounded-lg">
                ğŸ’¬ ×”×¦×’ Prompt ××•×ª×× ××™×©×™×ª
            </button>

            <button onclick="testNotification()" 
                    class="w-full bg-yellow-500 hover:bg-yellow-600 font-bold py-4 rounded-lg text-slate-900">
                ğŸ§ª ×©×œ×— ×”×ª×¨××ª ×‘×“×™×§×”
            </button>
        </div>

        <div id="log" class="mt-8 bg-black p-4 rounded-lg text-xs font-mono h-64 overflow-auto">
            <div class="text-green-400">ğŸ“‹ Console Log:</div>
        </div>
    </div>

    <script src="/push-notifications.js"></script>

    <script>
        const logEl = document.getElementById('log');
        const statusEl = document.getElementById('status');

        // Override console.log
        const originalLog = console.log;
        console.log = function(...args) {
            originalLog.apply(console, args);
            logEl.innerHTML += '<div class="text-green-400">' + args.join(' ') + '</div>';
            logEl.scrollTop = logEl.scrollHeight;
        };

        const originalError = console.error;
        console.error = function(...args) {
            originalError.apply(console, args);
            logEl.innerHTML += '<div class="text-red-400">âŒ ' + args.join(' ') + '</div>';
            logEl.scrollTop = logEl.scrollHeight;
        };

        function checkStatus() {
            statusEl.innerHTML = '';
            
            const checks = [
                {
                    name: 'Service Worker ×ª×•××š',
                    check: 'serviceWorker' in navigator,
                    emoji: 'ğŸ”§'
                },
                {
                    name: 'Push API ×ª×•××š',
                    check: 'PushManager' in window,
                    emoji: 'ğŸ“¡'
                },
                {
                    name: 'Notification API ×ª×•××š',
                    check: 'Notification' in window,
                    emoji: 'ğŸ””'
                },
                {
                    name: 'pushManager × ×˜×¢×Ÿ',
                    check: typeof window.pushManager !== 'undefined',
                    emoji: 'ğŸ“¦'
                },
                {
                    name: '××©×ª××© ××—×•×‘×¨',
                    check: localStorage.getItem('customerToken') !== null || localStorage.getItem('courierToken') !== null,
                    emoji: 'ğŸ‘¤'
                }
            ];

            checks.forEach(item => {
                const status = item.check ? 'âœ…' : 'âŒ';
                statusEl.innerHTML += `<div>${item.emoji} ${item.name}: ${status}</div>`;
            });

            // Permission status
            if ('Notification' in window) {
                const permStatus = Notification.permission;
                let color = 'text-yellow-400';
                if (permStatus === 'granted') color = 'text-green-400';
                if (permStatus === 'denied') color = 'text-red-400';
                
                statusEl.innerHTML += `<div class="${color}">ğŸ” ×”×¨×©××”: ${permStatus}</div>`;
            }

            console.log('Status check completed');
        }

        async function testPush() {
            console.log('=== Testing Push ===');
            
            if (!('Notification' in window)) {
                alert('âŒ ×”×“×¤×“×¤×Ÿ ×œ× ×ª×•××š ×‘-Notifications');
                return;
            }

            try {
                const permission = await Notification.requestPermission();
                console.log('Permission result:', permission);
                
                if (permission === 'granted') {
                    alert('âœ… ×”×¨×©××” × ×™×ª× ×”!');
                    
                    // Initialize if pushManager exists
                    if (window.pushManager) {
                        const userType = localStorage.getItem('customerToken') ? 'customer' : 'courier';
                        const userData = JSON.parse(localStorage.getItem(`${userType}Data`) || '{"id":1}');
                        await window.pushManager.init(userType, userData.id);
                    }
                } else if (permission === 'denied') {
                    alert('âŒ ×”×”×¨×©××” × ×“×—×ª×”. ×¦×¨×™×š ×œ××¤×©×¨ ×‘×”×’×“×¨×•×ª');
                } else {
                    alert('âš ï¸ ×”×”×¨×©××” ×œ× × ×™×ª× ×”');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('×©×’×™××”: ' + error.message);
            }
        }

        function showPrompt() {
            if (window.pushManager) {
                window.pushManager.showEnablePrompt();
            } else {
                alert('âŒ pushManager ×œ× × ×˜×¢×Ÿ!');
            }
        }

        function testNotification() {
            if (Notification.permission === 'granted') {
                new Notification('M.M.H Delivery - ×‘×“×™×§×”', {
                    body: '×”×”×ª×¨××•×ª ×¢×•×‘×“×•×ª! ğŸ‰',
                    icon: '/assets/logo.png',
                    vibrate: [200, 100, 200]
                });
                console.log('Test notification sent');
            } else {
                alert('âŒ ××™×Ÿ ×”×¨×©××”. ×ª×œ×—×¥ ×¢×œ "×‘×§×© ×”×¨×©××”" ×§×•×“×');
            }
        }

        // Auto-check on load
        window.addEventListener('load', () => {
            setTimeout(checkStatus, 1000);
        });
    </script>
</body>
</html>
