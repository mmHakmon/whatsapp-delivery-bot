    async function cancelOrder(id) { const reason=prompt('×¡×™×‘×”:'); if(reason===null)return; const r=await api('/api/orders/'+id+'/cancel','POST',{reason}); if(r?.success)toast('×‘×•×˜×œ×”'); }
    async function deleteOrder(id) { if(!confirm('×œ××—×•×§?'))return; const r=await api('/api/orders/'+id,'DELETE'); if(r?.success)toast('× ××—×§×”'); }
    async function createPayment(d) { const r=await api('/api/payments','POST',d); if(r?.success){toast('× ×¨×©×!');closeModal();loadData();loadPayments();}else toast(r?.error||'×©×’×™××”','error'); }
    async function createUser(d) { const r=await api('/api/users','POST',d); if(r?.success){toast('× ×•×¦×¨!');closeModal();loadUsers();}else toast(r?.error||'×©×’×™××”','error'); }
    async function deleteUser(id) { if(!confirm('×œ××—×•×§?'))return; const r=await api('/api/users/'+id,'DELETE'); if(r?.success){toast('× ××—×§');loadUsers();} }
    function closeModal() { document.getElementById('modal').innerHTML=''; }
    function showNewOrderModal() { document.getElementById('modal').innerHTML=`<div class="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4" onclick="if(event.target===this)closeModal()"><div class="bg-slate-800 rounded-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto"><div class="p-4 border-b border-slate-600 flex justify-between"><h2 class="font-bold">ğŸ“¦ ×”×–×× ×” ×—×“×©×”</h2><button onclick="closeModal()">âœ•</button></div><div class="p-4 space-y-3"><div class="grid grid-cols-2 gap-3"><input id="senderName" placeholder="×©× ×©×•×œ×—" class="bg-slate-900 border border-slate-600 rounded-lg px-3 py-2 text-sm"><input id="senderPhone" placeholder="×˜×œ×¤×•×Ÿ ×©×•×œ×—" class="bg-slate-900 border border-slate-600 rounded-lg px-3 py-2 text-sm"></div><input id="pickupAddress" placeholder="ğŸ“ ×›×ª×•×‘×ª ××™×¡×•×£" class="w-full bg-slate-900 border border-slate-600 rounded-lg px-3 py-2 text-sm"><div class="grid grid-cols-2 gap-3"><input id="receiverName" placeholder="×©× ××§×‘×œ" class="bg-slate-900 border border-slate-600 rounded-lg px-3 py-2 text-sm"><input id="receiverPhone" placeholder="×˜×œ×¤×•×Ÿ ××§×‘×œ" class="bg-slate-900 border border-slate-600 rounded-lg px-3 py-2 text-sm"></div><input id="deliveryAddress" placeholder="ğŸ  ×›×ª×•×‘×ª ××¡×™×¨×”" class="w-full bg-slate-900 border border-slate-600 rounded-lg px-3 py-2 text-sm"><textarea id="details" placeholder="×¤×¨×˜×™×" class="w-full bg-slate-900 border border-slate-600 rounded-lg px-3 py-2 text-sm h-16"></textarea><div class="grid grid-cols-2 gap-3"><input type="number" id="price" placeholder="××—×™×¨ â‚ª" class="bg-slate-900 border border-slate-600 rounded-lg px-3 py-2 text-sm"><select id="priority" class="bg-slate-900 border border-slate-600 rounded-lg px-3 py-2 text-sm"><option value="normal">×¨×’×™×œ</option><option value="express">××§×¡×¤×¨×¡</option><option value="urgent">×“×—×•×£</option></select></div><button onclick="submitOrder()" class="w-full bg-cyan-600 text-white py-3 rounded-lg font-bold">âœ… ×¦×•×¨</button></div></div></div>`; }
    function submitOrder() { createOrder({senderName:document.getElementById('senderName').value,senderPhone:document.getElementById('senderPhone').value,pickupAddress:document.getElementById('pickupAddress').value,receiverName:document.getElementById('receiverName').value,receiverPhone:document.getElementById('receiverPhone').value,deliveryAddress:document.getElementById('deliveryAddress').value,details:document.getElementById('details').value,price:parseInt(document.getElementById('price').value)||0,priority:document.getElementById('priority').value}); }
    function showPaymentModal(id,name,balance) { document.getElementById('modal').innerHTML=`<div class="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4" onclick="if(event.target===this)closeModal()"><div class="bg-slate-800 rounded-2xl w-full max-w-md"><div class="p-4 border-b border-slate-600 flex justify-between"><h2 class="font-bold">ğŸ’³ ×ª×©×œ×•×</h2><button onclick="closeModal()">âœ•</button></div><div class="p-4 space-y-4"><div class="text-center"><div>${name}</div><div class="text-2xl font-bold text-amber-400">×™×ª×¨×”: ${fmt(balance)}</div></div><input type="number" id="paymentAmount" value="${balance}" class="w-full bg-slate-900 border border-slate-600 rounded-lg px-3 py-2"><select id="paymentMethod" class="w-full bg-slate-900 border border-slate-600 rounded-lg px-3 py-2"><option value="cash">××–×•××Ÿ</option><option value="transfer">×”×¢×‘×¨×”</option><option value="bit">×‘×™×˜</option></select><button onclick="submitPayment(${id})" class="w-full bg-cyan-600 text-white py-3 rounded-lg font-bold">××©×¨</button></div></div></div>`; }
    function submitPayment(id) { createPayment({courier_id:id,amount:parseFloat(document.getElementById('paymentAmount').value)||0,method:document.getElementById('paymentMethod').value}); }
    function showNewUserModal() { document.getElementById('modal').innerHTML=`<div class="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4" onclick="if(event.target===this)closeModal()"><div class="bg-slate-800 rounded-2xl w-full max-w-md"><div class="p-4 border-b border-slate-600 flex justify-between"><h2 class="font-bold">ğŸ‘¤ ××©×ª××© ×—×“×©</h2><button onclick="closeModal()">âœ•</button></div><div class="p-4 space-y-3"><input id="newUsername" placeholder="×©× ××©×ª××©" class="w-full bg-slate-900 border border-slate-600 rounded-lg px-3 py-2"><input id="newPassword" type="password" placeholder="×¡×™×¡××”" class="w-full bg-slate-900 border border-slate-600 rounded-lg px-3 py-2"><input id="newName" placeholder="×©× ××œ×" class="w-full bg-slate-900 border border-slate-600 rounded-lg px-3 py-2"><input id="newPhone" placeholder="×˜×œ×¤×•×Ÿ" class="w-full bg-slate-900 border border-slate-600 rounded-lg px-3 py-2"><select id="newRole" class="w-full bg-slate-900 border border-slate-600 rounded-lg px-3 py-2"><option value="agent">× ×¦×™×’</option><option value="manager">×× ×”×œ</option><option value="admin">××“××™×Ÿ</option></select><button onclick="submitNewUser()" class="w-full bg-cyan-600 text-white py-3 rounded-lg font-bold">×¦×•×¨</button></div></div></div>`; }
    function submitNewUser() { createUser({username:document.getElementById('newUsername').value,password:document.getElementById('newPassword').value,name:document.getElementById('newName').value,phone:document.getElementById('newPhone').value,role:document.getElementById('newRole').value}); }
    function render() {
      if(!token||!user) { renderLogin(); return; }
      const fo = orders.filter(o => filter==='all' || o.status===filter);
      const isAdmin = user.role === 'admin';
      const isManager = user.role === 'manager' || isAdmin;
      document.getElementById('app').innerHTML=`
        <header class="bg-slate-800/80 backdrop-blur border-b border-slate-700 sticky top-0 z-40"><div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center"><div class="flex items-center gap-3"><img src="/logo.png" class="h-10"><div><h1 class="text-lg font-bold text-cyan-400">M.M.H v4.0</h1></div></div><div class="flex items-center gap-3"><span class="text-sm text-gray-400">ğŸ‘¤ ${user.name}</span><button onclick="logout()" class="px-3 py-1 bg-red-500/20 text-red-400 rounded text-sm">×™×¦×™××”</button></div></div></header>
        <main class="max-w-7xl mx-auto px-4 py-6">
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-slate-800/60 rounded-xl p-4"><div class="text-2xl font-bold">${stats.total||0}</div><div class="text-sm text-gray-400">×”×–×× ×•×ª</div></div>
            <div class="bg-slate-800/60 rounded-xl p-4"><div class="text-2xl font-bold text-amber-400">${(parseInt(stats.new)||0)+(parseInt(stats.published)||0)}</div><div class="text-sm text-gray-400">×××ª×™× ×•×ª</div></div>
            <div class="bg-slate-800/60 rounded-xl p-4"><div class="text-2xl font-bold text-blue-400">${stats.active||0}</div><div class="text-sm text-gray-400">×¤×¢×™×œ×•×ª</div></div>
            <div class="bg-slate-800/60 rounded-xl p-4"><div class="text-2xl font-bold text-emerald-400">${fmt(stats.revenue)}</div><div class="text-sm text-gray-400">×”×›× ×¡×•×ª</div></div>
          </div>
          <div class="flex flex-wrap gap-2 mb-4">
            <button onclick="tab='orders';render()" class="px-4 py-2 rounded-lg text-sm ${tab==='orders'?'bg-cyan-600 text-white':'bg-slate-700 text-gray-400'}">ğŸ“¦ ×”×–×× ×•×ª</button>
            <button onclick="tab='couriers';render()" class="px-4 py-2 rounded-lg text-sm ${tab==='couriers'?'bg-cyan-600 text-white':'bg-slate-700 text-gray-400'}">ğŸï¸ ×©×œ×™×—×™×</button>
            ${isManager?`<button onclick="tab='payments';loadPayments()" class="px-4 py-2 rounded-lg text-sm ${tab==='payments'?'bg-cyan-600 text-white':'bg-slate-700 text-gray-400'}">ğŸ’³ ×ª×©×œ×•××™×</button>`:''}
            ${isManager?`<button onclick="tab='reports';render()" class="px-4 py-2 rounded-lg text-sm ${tab==='reports'?'bg-cyan-600 text-white':'bg-slate-700 text-gray-400'}">ğŸ“Š ×“×•×—×•×ª</button>`:''}
            ${isAdmin?`<button onclick="tab='users';loadUsers()" class="px-4 py-2 rounded-lg text-sm ${tab==='users'?'bg-cyan-600 text-white':'bg-slate-700 text-gray-400'}">ğŸ‘¥ ××©×ª××©×™×</button>`:''}
          </div>
          ${tab==='orders'?renderOrders(fo):''}
          ${tab==='couriers'?renderCouriers():''}
          ${tab==='payments'?renderPayments():''}
          ${tab==='reports'?renderReports():''}
          ${tab==='users'?renderUsers():''}
        </main>`;
    }
    function renderOrders(fo) { return `<div class="flex flex-wrap gap-2 mb-4">${['all','new','published','taken','picked','delivered','cancelled'].map(f=>`<button onclick="filter='${f}';render()" class="px-3 py-1 rounded text-sm ${filter===f?'bg-cyan-500/30 text-cyan-400':'bg-slate-700 text-gray-400'}">${f==='all'?'×”×›×œ':statusLabels[f]}</button>`).join('')}<button onclick="showNewOrderModal()" class="mr-auto px-4 py-1 bg-cyan-600 text-white rounded text-sm">â• ×—×“×©×”</button></div><div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">${fo.map(o=>`<div class="bg-slate-800/60 rounded-xl overflow-hidden"><div class="p-3 border-b border-slate-700 flex justify-between items-center"><span class="font-bold text-cyan-400">${o.orderNumber}</span><span class="px-2 py-1 rounded text-xs ${statusColors[o.status]}">${statusLabels[o.status]}</span></div><div class="p-3 space-y-1 text-sm"><div class="text-gray-400">ğŸ“ ${o.pickupAddress}</div><div class="text-gray-400">ğŸ  ${o.deliveryAddress}</div><div class="flex justify-between pt-2"><span>××—×™×¨:</span><span class="font-bold">${fmt(o.price)}</span></div><div class="flex justify-between"><span>×œ×©×œ×™×—:</span><span class="font-bold text-cyan-400">${fmt(o.courierPayout)}</span></div>${o.courier?`<div class="bg-slate-700/50 rounded p-2 text-xs">ğŸï¸ ${o.courier.name}</div>`:''}</div><div class="p-3 pt-0">${o.status==='new'?`<div class="flex gap-2"><button onclick="publishOrder(${o.id})" class="flex-1 bg-cyan-600 text-white py-2 rounded text-sm">ğŸ“¤ ×¤×¨×¡×</button><button onclick="cancelOrder(${o.id})" class="px-3 bg-red-500/20 text-red-400 rounded">âœ•</button></div>`:''}${['published','taken','picked'].includes(o.status)?`<button onclick="cancelOrder(${o.id})" class="w-full bg-red-500/20 text-red-400 py-2 rounded text-sm">âŒ ×‘×˜×œ</button>`:''}${o.status==='cancelled'&&user.role==='admin'?`<button onclick="deleteOrder(${o.id})" class="w-full bg-red-500/20 text-red-400 py-2 rounded text-sm">ğŸ—‘ï¸ ××—×§</button>`:''}</div></div>`).join('')}</div>${fo.length===0?'<div class="text-center py-12 text-gray-400">××™×Ÿ ×”×–×× ×•×ª</div>':''}`; }
    function renderCouriers() { return `<div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">${couriers.map(c=>`<div class="bg-slate-800/60 rounded-xl p-4"><div class="flex justify-between items-center mb-3"><div><div class="font-bold">${c.first_name} ${c.last_name}</div><div class="text-sm text-gray-400">${c.phone}</div></div><span class="px-2 py-1 rounded text-xs ${c.status==='active'?'bg-emerald-500/20 text-emerald-400':'bg-red-500/20 text-red-400'}">${c.status==='active'?'×¤×¢×™×œ':'×œ× ×¤×¢×™×œ'}</span></div><div class="grid grid-cols-3 gap-2 text-center text-sm"><div class="bg-slate-700/50 rounded p-2"><div class="font-bold">${c.total_deliveries||0}</div><div class="text-xs text-gray-400">××©×œ×•×—×™×</div></div><div class="bg-slate-700/50 rounded p-2"><div class="font-bold text-cyan-400">${fmt(c.total_earned)}</div><div class="text-xs text-gray-400">×¡×”"×›</div></div><div class="bg-slate-700/50 rounded p-2"><div class="font-bold text-amber-400">${fmt(c.balance)}</div><div class="text-xs text-gray-400">×™×ª×¨×”</div></div></div>${parseFloat(c.balance)>0?`<button onclick="showPaymentModal(${c.id},'${c.first_name} ${c.last_name}',${c.balance})" class="w-full mt-3 bg-cyan-500/20 text-cyan-400 py-2 rounded text-sm">ğŸ’³ ×©×œ×</button>`:''}</div>`).join('')}</div>${couriers.length===0?'<div class="text-center py-12 text-gray-400">××™×Ÿ ×©×œ×™×—×™×</div>':''}`; }
    function renderPayments() { return `<div class="bg-slate-800/60 rounded-xl overflow-hidden"><table class="w-full text-sm"><thead class="bg-slate-700/50"><tr><th class="p-3 text-right">×ª××¨×™×š</th><th class="p-3 text-right">×©×œ×™×—</th><th class="p-3 text-right">×¡×›×•×</th><th class="p-3 text-right">×××¦×¢×™</th></tr></thead><tbody>${payments.map(p=>`<tr class="border-t border-slate-700"><td class="p-3">${new Date(p.created_at).toLocaleDateString('he-IL')}</td><td class="p-3">${p.first_name} ${p.last_name}</td><td class="p-3 font-bold text-emerald-400">${fmt(p.amount)}</td><td class="p-3">${methodLabels[p.method]||p.method}</td></tr>`).join('')}</tbody></table>${payments.length===0?'<div class="text-center py-8 text-gray-400">××™×Ÿ ×ª×©×œ×•××™×</div>':''}</div>`; }
    function renderReports() { return `<div class="grid md:grid-cols-2 gap-6"><div class="bg-slate-800/60 rounded-xl p-6"><h3 class="font-bold text-lg mb-4">ğŸ“¥ ×™×™×¦×•× × ×ª×•× ×™×</h3><div class="space-y-3"><a href="/api/reports/export/orders" target="_blank" class="block w-full bg-cyan-600 text-white py-3 rounded-lg text-center font-medium">ğŸ“¦ ×™×™×¦×•× ×”×–×× ×•×ª (CSV)</a><a href="/api/reports/export/couriers" target="_blank" class="block w-full bg-emerald-600 text-white py-3 rounded-lg text-center font-medium">ğŸï¸ ×™×™×¦×•× ×©×œ×™×—×™× (CSV)</a><a href="/api/reports/export/payments" target="_blank" class="block w-full bg-amber-600 text-white py-3 rounded-lg text-center font-medium">ğŸ’³ ×™×™×¦×•× ×ª×©×œ×•××™× (CSV)</a></div></div><div class="bg-slate-800/60 rounded-xl p-6"><h3 class="font-bold text-lg mb-4">ğŸ“Š ×¡×™×›×•× 30 ×™×•×</h3><div class="space-y-2 text-sm"><div class="flex justify-between"><span>×¡×”"×› ×”×–×× ×•×ª:</span><span class="font-bold">${stats.total||0}</span></div><div class="flex justify-between"><span>× ××¡×¨×•:</span><span class="font-bold text-emerald-400">${stats.delivered||0}</span></div><div class="flex justify-between"><span>×”×›× ×¡×•×ª:</span><span class="font-bold">${fmt(stats.revenue)}</span></div><div class="flex justify-between"><span>×¢××œ×•×ª:</span><span class="font-bold text-cyan-400">${fmt(stats.commission)}</span></div></div></div></div>`; }
    function renderUsers() { return `<div class="mb-4"><button onclick="showNewUserModal()" class="px-4 py-2 bg-cyan-600 text-white rounded-lg text-sm">â• ××©×ª××© ×—×“×©</button></div><div class="bg-slate-800/60 rounded-xl overflow-hidden"><table class="w-full text-sm"><thead class="bg-slate-700/50"><tr><th class="p-3 text-right">×©×</th><th class="p-3 text-right">××©×ª××©</th><th class="p-3 text-right">×ª×¤×§×™×“</th><th class="p-3 text-right">×¤×¢×•×œ×•×ª</th></tr></thead><tbody>${users.map(u=>`<tr class="border-t border-slate-700"><td class="p-3">${u.name}</td><td class="p-3">${u.username}</td><td class="p-3">${roleLabels[u.role]||u.role}</td><td class="p-3">${u.id!==user.id?`<button onclick="deleteUser(${u.id})" class="text-red-400 text-xs">ğŸ—‘ï¸ ××—×§</button>`:''}</td></tr>`).join('')}</tbody></table></div>`; }
    function renderLogin() { document.getElementById('app').innerHTML=`<div class="min-h-screen flex items-center justify-center p-4"><div class="bg-slate-800 rounded-2xl p-8 w-full max-w-md"><div class="text-center mb-8"><img src="/logo.png" class="h-24 mx-auto mb-4"><h1 class="text-2xl font-bold text-cyan-400">M.M.H ××©×œ×•×—×™×</h1><p class="text-gray-400">×”×ª×—×‘×¨×•×ª ×œ××¢×¨×›×ª</p></div><div class="space-y-4"><input type="text" id="loginUser" placeholder="×©× ××©×ª××©" class="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-3"><input type="password" id="loginPass" placeholder="×¡×™×¡××”" class="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-3"><button onclick="handleLogin()" class="w-full bg-cyan-600 text-white py-3 rounded-lg font-bold">×”×ª×—×‘×¨</button></div></div></div>`; document.getElementById('loginPass')?.addEventListener('keyup',e=>{if(e.key==='Enter')handleLogin();}); }
    function handleLogin() { login(document.getElementById('loginUser').value,document.getElementById('loginPass').value); }
    async function init() { if(await checkAuth()){connectWS();loadData();} render(); }
    init();
  </script>
</body>
</html>
