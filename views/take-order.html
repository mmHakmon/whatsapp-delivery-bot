<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>×ª×¤×™×¡×ª ××©×œ×•×— - M.M.H</title>
  <link rel="icon" href="/logo.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>* { font-family: system-ui, sans-serif; }</style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-900 to-slate-800 text-white p-4">
  <div id="app" class="max-w-md mx-auto"></div>
  
  <script>
    const orderNumber = window.location.pathname.split('/').pop();
    
    async function loadOrder() {
      try {
        const res = await fetch('/api/orders?search=' + orderNumber);
        const orders = await res.json();
        const order = orders.find(o => o.orderNumber === orderNumber);
        
        if (!order) {
          showError('×”×–×× ×” ×œ× × ××¦××”');
          return;
        }
        
        if (order.status !== 'published') {
          showTaken();
          return;
        }
        
        showForm(order);
      } catch (e) {
        showError('×©×’×™××” ×‘×˜×¢×™× ×”');
      }
    }
    
    function showForm(order) {
      document.getElementById('app').innerHTML = `
        <div class="text-center mb-6">
          <img src="/logo.png" class="h-16 mx-auto mb-4">
          <h1 class="text-xl font-bold text-cyan-400">M.M.H ××©×œ×•×—×™×</h1>
          <p class="text-gray-400">××©×œ×•×— ${order.orderNumber}</p>
        </div>
        
        <div class="bg-slate-800 rounded-xl p-4 mb-4 space-y-3">
          <div class="flex items-start gap-3">
            <span class="text-2xl">ğŸ“</span>
            <div>
              <div class="text-xs text-gray-400">×›×ª×•×‘×ª ××™×¡×•×£</div>
              <div>${order.pickupAddress}</div>
            </div>
          </div>
          <div class="flex items-start gap-3">
            <span class="text-2xl">ğŸ </span>
            <div>
              <div class="text-xs text-gray-400">×›×ª×•×‘×ª ××¡×™×¨×”</div>
              <div>${order.deliveryAddress}</div>
            </div>
          </div>
          <div class="flex items-center gap-3 pt-2 border-t border-slate-700">
            <span class="text-2xl">ğŸ’°</span>
            <div>
              <div class="text-xs text-gray-400">×ª×©×œ×•× ×œ×©×œ×™×—</div>
              <div class="text-2xl font-bold text-emerald-400">â‚ª${order.courierPayout}</div>
            </div>
          </div>
        </div>
        
        <div class="bg-slate-800 rounded-xl p-4 space-y-3" id="form">
          <div id="error" class="hidden bg-red-500/20 border border-red-500 rounded-lg p-3 text-red-400 text-sm"></div>
          <input type="text" id="firstName" placeholder="×©× ×¤×¨×˜×™" class="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-3">
          <input type="text" id="lastName" placeholder="×©× ××©×¤×—×”" class="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-3">
          <input type="text" id="idNumber" placeholder="×ª×¢×•×“×ª ×–×”×•×ª" maxlength="9" class="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-3">
          <input type="tel" id="phone" placeholder="×˜×œ×¤×•×Ÿ" class="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-3">
          <button onclick="submit()" id="btn" class="w-full bg-gradient-to-r from-emerald-500 to-cyan-500 text-white py-4 rounded-lg font-bold text-lg">
            âœ‹ ×ª×¤×•×¡ ××ª ×”××©×œ×•×—!
          </button>
        </div>
        
        <div id="success" class="hidden bg-slate-800 rounded-xl p-8 text-center">
          <div class="text-6xl mb-4">ğŸ‰</div>
          <h2 class="text-2xl font-bold text-emerald-400 mb-2">×ª×¤×¡×ª ××ª ×”××©×œ×•×—!</h2>
          <p class="text-gray-400">×”×¤×¨×˜×™× × ×©×œ×—×• ××œ×™×š ×‘×•×•××˜×¡××¤</p>
        </div>
      `;
    }
    
    function showTaken() {
      document.getElementById('app').innerHTML = `
        <div class="bg-slate-800 rounded-xl p-8 text-center">
          <div class="text-6xl mb-4">ğŸï¸</div>
          <h2 class="text-2xl font-bold text-amber-400 mb-2">×”××©×œ×•×— × ×ª×¤×¡!</h2>
          <p class="text-gray-400">××™×©×”×• ×”×¡×¤×™×§ ×œ×¤× ×™×š, ×¤×¢× ×”×‘××” ×ª×”×™×” ××”×™×¨ ×™×•×ª×¨!</p>
        </div>
      `;
    }
    
    function showError(msg) {
      document.getElementById('app').innerHTML = `
        <div class="bg-slate-800 rounded-xl p-8 text-center">
          <div class="text-6xl mb-4">âŒ</div>
          <h2 class="text-2xl font-bold text-red-400 mb-2">${msg}</h2>
        </div>
      `;
    }
    
    async function submit() {
      const btn = document.getElementById('btn');
      const error = document.getElementById('error');
      
      const data = {
        firstName: document.getElementById('firstName').value.trim(),
        lastName: document.getElementById('lastName').value.trim(),
        idNumber: document.getElementById('idNumber').value.trim(),
        phone: document.getElementById('phone').value.trim()
      };
      
      if (!data.firstName || !data.lastName || !data.idNumber || !data.phone) {
        error.textContent = '× × ×œ××œ× ××ª ×›×œ ×”×©×“×•×ª';
        error.classList.remove('hidden');
        return;
      }
      
      btn.disabled = true;
      btn.textContent = '×©×•×œ×—...';
      error.classList.add('hidden');
      
      try {
        const res = await fetch('/api/take/' + orderNumber, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        const result = await res.json();
        
        if (result.success) {
          document.getElementById('form').classList.add('hidden');
          document.getElementById('success').classList.remove('hidden');
        } else {
          error.textContent = result.error || '×©×’×™××”';
          error.classList.remove('hidden');
          btn.disabled = false;
          btn.textContent = 'âœ‹ ×ª×¤×•×¡ ××ª ×”××©×œ×•×—!';
        }
      } catch (e) {
        error.textContent = '×©×’×™××ª ×ª×§×©×•×¨×ª';
        error.classList.remove('hidden');
        btn.disabled = false;
        btn.textContent = 'âœ‹ ×ª×¤×•×¡ ××ª ×”××©×œ×•×—!';
      }
    }
    
    loadOrder();
  </script>
</body>
</html>
