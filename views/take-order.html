<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>×ª×¤×™×¡×ª ××©×œ×•×— - M.M.H</title>
  <link rel="icon" type="image/png" href="/logo.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>* { font-family: 'Heebo', sans-serif; }</style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 text-white flex items-center justify-center p-4">
  <div id="app" class="w-full max-w-md"><div class="text-center py-12"><div class="animate-spin text-4xl mb-4">â³</div><p class="text-gray-400">×˜×•×¢×Ÿ...</p></div></div>
  <script>
    const orderNumber = window.location.pathname.split('/')[2];
    let orderData = null;
    const savedCourier = JSON.parse(localStorage.getItem('courier') || '{}');
    
    async function loadOrder() {
      try {
        const res = await fetch('/api/orders/public/' + orderNumber);
        const order = await res.json();
        if (!order || order.error) { showError('×”××©×œ×•×— ×œ× × ××¦×'); return; }
        if (order.status !== 'published') { showTaken(order); return; }
        orderData = order;
        showTakeForm(order);
      } catch (e) { showError('×©×’×™××” ×‘×˜×¢×™× ×”'); }
    }
    
    function showTakeForm(order) {
      document.getElementById('app').innerHTML = `
        <div class="bg-slate-800/80 backdrop-blur rounded-2xl overflow-hidden shadow-2xl">
          <div class="bg-gradient-to-r from-cyan-600 to-blue-500 p-6 text-center">
            <div class="text-4xl mb-2">ğŸšš</div>
            <h1 class="text-xl font-bold">××©×œ×•×— ×—×“×©!</h1>
            <div class="text-lg opacity-90 mt-1">${order.order_number}</div>
          </div>
          <div class="p-6 space-y-4">
            <div class="bg-slate-700/50 rounded-xl p-4">
              <div class="text-sm text-gray-400 mb-1">ğŸ“ ××™×¡×•×£</div>
              <div class="font-medium">${order.pickup_address}</div>
            </div>
            <div class="bg-slate-700/50 rounded-xl p-4">
              <div class="text-sm text-gray-400 mb-1">ğŸ  ×™×¢×“</div>
              <div class="font-medium">${order.delivery_address}</div>
            </div>
            ${order.details ? `<div class="bg-slate-700/50 rounded-xl p-4"><div class="text-sm text-gray-400 mb-1">ğŸ“ ×¤×¨×˜×™×</div><div class="font-medium">${order.details}</div></div>` : ''}
            <div class="bg-emerald-500/20 rounded-xl p-4 text-center">
              <div class="text-sm text-gray-400 mb-1">ğŸ’° ×ª×©×œ×•×</div>
              <div class="text-3xl font-bold text-emerald-400">â‚ª${order.courier_payout}</div>
            </div>
            <div class="border-t border-slate-600 pt-4 mt-4">
              <h2 class="font-bold text-center mb-4">×¤×¨×˜×™ ×©×œ×™×—</h2>
              <div class="space-y-3">
                <div class="grid grid-cols-2 gap-3">
                  <input type="text" id="firstName" placeholder="×©× ×¤×¨×˜×™" value="${savedCourier.firstName || ''}" class="bg-slate-900 border border-slate-600 rounded-lg px-3 py-3 text-center">
                  <input type="text" id="lastName" placeholder="×©× ××©×¤×—×”" value="${savedCourier.lastName || ''}" class="bg-slate-900 border border-slate-600 rounded-lg px-3 py-3 text-center">
                </div>
                <input type="tel" id="idNumber" placeholder="×ª×¢×•×“×ª ×–×”×•×ª" value="${savedCourier.idNumber || ''}" class="w-full bg-slate-900 border border-slate-600 rounded-lg px-3 py-3 text-center" maxlength="9">
                <input type="tel" id="phone" placeholder="×˜×œ×¤×•×Ÿ × ×™×™×“" value="${savedCourier.phone || ''}" class="w-full bg-slate-900 border border-slate-600 rounded-lg px-3 py-3 text-center">
                <label class="flex items-center gap-2 text-sm text-gray-400">
                  <input type="checkbox" id="saveInfo" ${savedCourier.firstName ? 'checked' : ''} class="rounded">
                  ×–×›×•×¨ ××ª ×”×¤×¨×˜×™× ×©×œ×™
                </label>
              </div>
            </div>
            <button onclick="takeOrder()" id="takeBtn" class="w-full bg-gradient-to-r from-emerald-600 to-cyan-500 text-white py-4 rounded-xl font-bold text-lg">âœ… ×× ×™ ×œ×•×§×—!</button>
          </div>
        </div>`;
    }
    
    function showTaken(order) {
      document.getElementById('app').innerHTML = `
        <div class="bg-slate-800/80 backdrop-blur rounded-2xl overflow-hidden shadow-2xl text-center p-8">
          <div class="text-6xl mb-4">ğŸ˜”</div>
          <h1 class="text-xl font-bold text-amber-400 mb-2">×”××©×œ×•×— ×›×‘×¨ × ×ª×¤×¡!</h1>
          <p class="text-gray-400">××™×©×”×• ×”×§×“×™× ××•×ª×š...</p>
          <p class="text-gray-500 mt-4">×”××ª×Ÿ ×œ××©×œ×•×— ×”×‘× ×‘×§×‘×•×¦×”</p>
        </div>`;
    }
    
    async function takeOrder() {
      const firstName = document.getElementById('firstName').value.trim();
      const lastName = document.getElementById('lastName').value.trim();
      const idNumber = document.getElementById('idNumber').value.trim();
      const phone = document.getElementById('phone').value.trim();
      const saveInfo = document.getElementById('saveInfo').checked;
      
      if (!firstName || !lastName) { alert('× × ×œ×”×–×™×Ÿ ×©× ××œ×'); return; }
      if (!idNumber || idNumber.length !== 9) { alert('× × ×œ×”×–×™×Ÿ ×ª×¢×•×“×ª ×–×”×•×ª ×ª×§×™× ×” (9 ×¡×¤×¨×•×ª)'); return; }
      if (!phone || phone.length < 9) { alert('× × ×œ×”×–×™×Ÿ ××¡×¤×¨ ×˜×œ×¤×•×Ÿ ×ª×§×™×Ÿ'); return; }
      
      if (saveInfo) localStorage.setItem('courier', JSON.stringify({ firstName, lastName, idNumber, phone }));
      else localStorage.removeItem('courier');
      
      const btn = document.getElementById('takeBtn');
      btn.disabled = true;
      btn.innerHTML = '<span class="animate-pulse">×©×•×œ×—...</span>';
      
      try {
        const res = await fetch('/api/take/' + orderNumber, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ firstName, lastName, idNumber, phone })
        });
        const result = await res.json();
        if (result.success) showSuccess();
        else { alert(result.error || '×©×’×™××”'); btn.disabled = false; btn.textContent = 'âœ… ×× ×™ ×œ×•×§×—!'; }
      } catch (e) { alert('×©×’×™××ª ×¨×©×ª'); btn.disabled = false; btn.textContent = 'âœ… ×× ×™ ×œ×•×§×—!'; }
    }
    
    function showSuccess() {
      document.getElementById('app').innerHTML = `
        <div class="bg-slate-800/80 backdrop-blur rounded-2xl overflow-hidden shadow-2xl text-center p-8">
          <div class="text-6xl mb-4">ğŸ‰</div>
          <h1 class="text-2xl font-bold text-emerald-400 mb-2">×ª×¤×¡×ª ××ª ×”××©×œ×•×—!</h1>
          <p class="text-gray-400 mb-6">×§×™×‘×œ×ª ×”×•×“×¢×” ×‘×•×•×˜×¡××¤ ×¢× ×›×œ ×”×¤×¨×˜×™×</p>
          <div class="space-y-3">
            <a href="https://waze.com/ul?q=${encodeURIComponent(orderData?.pickup_address || '')}" target="_blank" class="block w-full bg-gradient-to-r from-blue-600 to-cyan-500 text-white py-4 rounded-xl font-bold text-lg">ğŸ—ºï¸ × ×•×•×˜ ×œ××™×¡×•×£</a>
            <a href="/status/${orderNumber}/pickup" class="block w-full bg-slate-700 text-white py-3 rounded-xl font-medium">ğŸ“¦ ×œ××™×©×•×¨ ××™×¡×•×£</a>
          </div>
        </div>`;
    }
    
    function showError(msg) {
      document.getElementById('app').innerHTML = `<div class="bg-slate-800/80 backdrop-blur rounded-2xl p-8 text-center"><div class="text-6xl mb-4">âŒ</div><h1 class="text-xl font-bold text-red-400">${msg}</h1></div>`;
    }
    
    loadOrder();
  </script>
</body>
</html>
